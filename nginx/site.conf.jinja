{% if aliases %}
server {
  listen 80;
  server_name {{ aliases|join(" ") }};
  rewrite ^ http://{{ fqdn }}$request_uri? permanent;
}
{% endif %}

{%- set upstream_name = fqdn|replace(".", "-") ~ "-backend" %}
{%- if upstreams %}
upstream {{ upstream_name }} {
  {%- for upstream in upstreams %}
  server {{ upstream }} fail_timeout=0;
  {%- endfor %}
}
{%- endif %}

server {
  server_name {{ fqdn }};
  client_max_body_size 10m;

  root {{ root }};

  access_log  /var/log/nginx/{{ fqdn }}.access.log;

  keepalive_timeout 5;

  location ~ /(favicon.ico|robots.txt) {
    access_log off;
    log_not_found off;
  }

  {%- if static_prefix %}
  location {{ static_prefix }} {
    expires max;
    access_log off;
  }
  {%- endif %}

  location / {
    {%- if upstreams %}
    try_files $uri @{{ upstream_name }};
    {%- else %}
    index  index.html;
    {%- if autoindex %}
    autoindex on;
    autoindex_exact_size off;
    {%- endif %}
  {%- endif %}

  }
  {%- if upstreams %}
  location @{{ upstream_name }}  {
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header Host $http_host;
    proxy_redirect off;

    proxy_pass http://{{ upstream_name }};
  }
  {%- endif %}
}
